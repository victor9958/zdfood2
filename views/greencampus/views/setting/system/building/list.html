<title>楼撞列表</title>
<style>
    .btn-bar {
        background: #f7f8fa;
        padding: 4px 10px;
    }
</style>
<body>
<!-- 楼撞列表 -->
<div class='layui-fluid full-height '>
    <div class='layui-card full-height over-auto'>
        <!-- //上面的head，标题  -->
        <div class="layui-card-header">楼撞列表</div>
        <!-- //content身体部分  -->
        <div class='layui-card-body flex-1 flex'>
            <!-- //设置-webkit-box-flex: 1;  -->
            <div class='flex-1 over-auto'>
                <fieldset class="layui-elem-field">
                    <legend>搜索条件</legend>
                    <div class="layui-form">
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <!-- 下拉列表模板渲染  -->
                                <div class="layui-input-inline">
                                    <script type="text/html" template
                                            lay-url="{{layui.setter.baseUrl}}/system/site/campuses"
                                            lay-done="{{layui.form.render()}}">
                                        <select name="campusId" id="building_campus" lay-filter="campus">
                                            <option value="" disabled selected>请选择校区</option>
                                            {{# layui.each(d.data, function(index, item){ }}
                                            <option value="{{item.id}}">{{item.name}}</option>
                                            {{# }); }}
                                        </select>
                                    </script>
                                </div>
                                <div class="layui-input-inline">
                                        <script type="text/html" template lay-url="{{layui.setter.baseUrl}}/system/site/areas?withoutPage=1"
                                            lay-done="{{layui.form.render()}}">
                                        <select name="areaId" id="">
                                            <option value="" disabled selected>请选择位置</option>
                                            {{#
                                            layui.each(d.data, function(index, item){
                                            }}
                                            <option value="{{item.id}}">{{item.name}}</option>
                                            {{# }) }}
                                        </select>
                                    </script>
                                    </div>
                                <div class="layui-inline ">
                                    <button class="layui-btn" lay-submit lay-filter="LAY-building_search">搜索</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </fieldset>
                <div class="m-b-10 btn-bar">
                    <button class="layui-btn layui-btn-sm " id="data-sync">数据同步</button>
                </div>
                <div class="layui-form">
                    <!-- <div class="layui-card-body"> -->
                        <table class="layui-hide" id="buildlist" lay-filter="buildlist"></table>
                        <script type="text/html" id="bulList">
                            <div class="layui-btn-container">
                                <button class="layui-btn layui-btn-xs" lay-event="edit">修改所属区域</button>
                                <button class="layui-btn layui-btn-xs" lay-event="detail">详情</button>
                                <button class="layui-btn layui-btn-xs" lay-event="del">删除</button>
                            </div>
                        </script>
                    <!-- </div> -->
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    layui.use(['admin', 'form', 'table'], function () {
        var $ = layui.$,
            admin = layui.admin,
            view = layui.view,
            setter = layui.setter,
            form = layui.form,
            laydate = layui.laydate,
            upload = layui.upload,
            table = layui.table;


        $(function () {
            var cols = [[ //表头
                {type: 'numbers', title: '序号', width: 60}
                , {field: 'name', title: '名称'}
                , {field: 'campusName', title: '所属校区'}
                , {field: 'areaName', title: '所属区域'}
                , {field: 'floor', title: '最高楼层'}
                , {title: '操作', align: 'center', toolbar: '#bulList'}

            ]];

            //获取表格数据

            function getList(data) {
                table.render(
                    {
                        elem: '#buildlist'
                        , url: setter.baseUrl + '/system/site/buildings'
                        , response: setter.responseTable
                        , page: setter.pageTable
                        , cols: cols,
                        where: data
                    }
                );
            }

            getList();
            //点击搜索订单
            form.on('submit(LAY-building_search)', function () {
                var campusId = $('#building_campus').val();
                var data = {'campusId': campusId}
                getList(data);
            });
            // 监听工具条的点击事件
            table.on('tool(buildlist)', function (obj) { //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
                var data = obj.data; //获得当前行数据
                var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
                var tr = obj.tr; //获得当前行 tr 的DOM对象
                if (layEvent === 'detail') { //详情
                    layui.data('buildingId', {
                        key: 'id'
                        , value: data.id
                    });
                    window.location.href = "/#/setting/system/building/listEadit";
                } else if (layEvent === 'edit') {//编辑所属区域
                    layui.data('buildingId', {
                        key: 'campusId'
                        , value: data.campus_id
                    });
                    layui.data('buildingId', {
                        key: 'id'
                        , value: data.id
                    });
                    admin.popupCenter({
                        id: 'LAY_editBuildingArea'
                        , title: '修改所属区域'
                        , area: ['400px', '260px']
                        , success: function () {
                            view(this.id).render('setting/system/building/editBuildingArea');
                        }
                    });
                } else if (layEvent === 'del') {  //删除
                    layer.confirm('确定要删除该区域?', {icon: 1, title: '提示'}, function (index) {
                        var idList = obj.data.id;
                        admin.req({
                            url: setter.baseUrl + '/system/site/buildings'
                            , type: 'delete'
                            , data: {'idList': [idList]}
                            , done: function (res) {
                                //关闭右侧面板
                                layer.close(admin.popup.index);
                                layer.msg(res.message, {icon: 1, time: 2000});
                                getList();
                            }
                        });
                    });
                }

            });
            //修改所属区域
            form.on('submit(LAY-edit-buildingArea)', function (obj) {
                admin.req({
                    url: setter.baseUrl + '/system/site/building/' + layui.data('buildingId').id + '/area'
                    , type: 'put'
                    , data: obj.field
                    , done: function (res) {
                        //关闭右侧面板
                        layer.close(admin.popup.index);
                        getList();

                        layer.msg(res.message, {icon: 1, time: 2000});
                    }
                });
            });

            // 数据同步
            $(document).off('click', '#data-sync');
            $(document).on('click', '#data-sync', function () {
                var campusId = $('#building_campus').val();
                console.log(campusId);
                admin.req({
                    //请求接口
                    url: setter.baseUrl + '/system/site/buildings-sync',
                    type: 'put',
                    data: {'campusId': campusId},
                    done: function (res) {
                        view('old_mobile')
                        layer.msg(res.message, {icon: 1, time: 2000});
                        layer.close(admin.popup.index);//关闭右侧面板
                        getList(campusId);
                    }
                });
            })
        });
    });
</script>