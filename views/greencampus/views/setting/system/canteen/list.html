<!-- 食堂列表 -->
<title>食堂列表</title>
<div class="layui-fluid full-height  ">
    <div class="layui-card full-height over-auto ">
        <div class="layui-card-header">食堂列表</div>
        <div class="layui-card-body">
            <fieldset class="layui-elem-field">
                <legend>搜索条件</legend>
                <div class="layui-form">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <!-- 下拉列表模板渲染  -->
                            <div class="layui-input-inline">
                                <script type="text/html" template lay-url="{{layui.setter.baseUrl}}/system/site/campuses"
                                    lay-done="{{layui.form.render()}}">
                                    <select name="campusId" id="campus" lay-filter="campus">
                                        <option value="" disabled selected>请选择校区</option>
                                        {{# layui.each(d.data, function(index, item){ }}
                                        <option value="{{item.id}}">{{item.name}}</option>
                                        {{# }); }}
                                    </select>
                                </script>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <button class="layui-btn " lay-submit lay-filter="search">查询</button>
                            <button class="layui-btn" id='datasyz' lay-submit lay-filter='datasyz'>数据同步</button>
                        </div>
                    </div>
                </div>
            </fieldset>
            <!-- 财务报表详情 -->
            <table class="layui-hide" id="cantList" lay-filter="cantList"></table>
        </div>
    </div>
</div>

<script type="text/html" id="upCanlist">
    <a class="layui-btn layui-btn-xs layui-btn " lay-event="edit">编辑</a>
</script>

<script>
    layui.use(['admin', 'form', 'table', 'laydate'], function () {
        var $ = layui.$,
            admin = layui.admin,
            view = layui.view,
            setter = layui.setter,
            form = layui.form,
            laydate = layui.laydate,
            table = layui.table,
            upload = layui.upload,
            laydate = layui.laydate;

        $(function () {
            var cols = [[{ field: 'campusName', title: '校区' }
                , { field: 'name', title: '名称' }
                , { field: 'phone', title: '电话' }
                , { field: 'address', title: '地址' }
                , { field: 'description', title: '就餐方式' }
                // 就餐时间待定
                , { field: 'lunch_start_at', title: '就餐时间' }
                , { title: '详情', align: 'center', toolbar: '#upCanlist' }
            ]];
            getData();
            function getData(data) {
                table.render(
                    {
                        elem: '#cantList'
                        , url: setter.baseUrl + '/system/site/canteens'
                        , response: setter.responseTable
                        , page: setter.pageTable
                        , cols: cols,
                        where: data
                    }
                );
            }


            //点击搜索订单
            form.on('submit(search)', function (obj) {
                console.log(obj);
                table.reload('cantList', {
                    url: setter.baseUrl + '/system/site/canteens',
                    response: setter.responseTable,
                    page: setter.pageTable,
                    cols: cols,
                    where: obj.field
                });
            });

            // 监听工具条的点击事件
            table.on('tool(cantList)', function (obj) {
                var data = obj.data; //获得当前行数据
                var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
                var tr = obj.tr; //获得当前行 tr 的DOM对象
                var id = data.id;
                layui.data('canteenId', {
                    key: 'id',
                    value: id
                });

                console.log('iddidid' + id);
                if (obj.event === 'edit') {
                    //编辑按钮
                    admin.req({
                        url: setter.baseUrl + '/system/site/canteen/' + id
                        , type: 'get'
                        // , data: { idList: userIdList }
                        , done: function (res) {
                            location.hash = '/setting/system/canteen/listXq';
                        }
                    });
                }

            });

            // 数据同步按钮
            $(document).off('click', '#datasyz');
            $(document).on('click', '#datasyz', function () {
                var campusId = $('#campus').val();
                admin.req({
                    url: setter.baseUrl + '/system/site/canteens-sync'
                    , type: 'put'
                    , data: { campusId: campusId }
                    , done: function (res) {
                        getData(campusId);
                        layer.msg(res.message, { icon: 1, time: 2000 });
                        // layer.close(admin.popup.index);//关闭右侧面板
                      
                    }
                });
            })
        });
    });
</script>