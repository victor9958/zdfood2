<style>
    .slideshow-wrapper .layui-card-body .header {
        margin-top: 40px;
        margin-bottom: 20px;
    }

    .btn-bar {
        background: #f7f8fa;
        padding: 4px 10px;
    }

    #specialty {
        width: 30px;
        padding: 0 10px;
        border: 1px solid #E6E6E6;
        border-radius: 4px;
        text-align: center;
        margin-left: 10px;
    }

    .specialtyTxt {
        line-height: 32px;
    }
</style>

<title>轮播图管理</title>
<div class="layui-fluid full-height slideshow-wrapper">
    <div class="layui-card full-height over-auto">
        <div class="layui-card-body">
            <!-- 小按钮栏 -->
            <div class="m-b-10 btn-bar">
                <button class="layui-btn  layui-btn-sm layui-btn-primary" id="addPlacard" lay-event="addPlacard">添加轮播图
                </button>
                <button class="layui-btn  layui-btn-sm layui-btn-danger" id="deletePlacard" lay-event="deletePlacard">
                    批量删除
                </button>
            </div>
            <div class="layui-form-item">
                <div class="layui-inline  pull-right">
                    <div class="layui-inline flex">
                        <p class="specialtyTxt">当前轮播图数量为</p>
                        <input id="specialty" type="text" value="">
                        <!-- 当前招牌菜数量为  -->
                    </div>
                </div>
            </div>
            <table id="tableSlideshow" lay-filter="tableSlideshow"></table>
        </div>
    </div>
</div>
<script type="text/html" id="slideshowOperate">
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="delete">删除</a>
</script>

<script>

    layui.define(['admin', 'table', 'form', 'laydate'], function (exports) {
        var $ = layui.$,
            admin = layui.admin,
            table = layui.table,
            setter = layui.setter,
            laydate = layui.laydate,
            view = layui.view,
            distpicker = layui.distpicker,
            form = layui.form;

        $(function () {

            var cols = [[
                {type: 'checkbox', fixed: 'left'},
                {type: 'numbers', title: '序号', width: 60},
                {field: 'name', title: '名称'},
                {
                    field: 'image_url', title: '轮播图', templet: function (d) {
                        return '<img width="30" height="30" src="' + d.image_url + '">';
                    }
                },
                {
                    field: 'status', title: '状态', templet: function (d) {
                        if (d.status == 0) {
                            return '关闭'
                        } else if (d.status == 1) {
                            return '开启'
                        }

                    }
                },
                {field: 'sort', title: '排序'},
                {
                    field: 'created_at', title: '创建时间', templet: function (d) {
                        return d.created_at ? d.created_at.split(' ')[0] : '无'
                    }
                },
                {title: '操作', align: 'center', toolbar: '#slideshowOperate', width: '20%'},
            ]];

            table.render({
                elem: '#tableSlideshow',
                url: setter.baseUrl + '/system/placards',
                response: setter.responseTable,
                page: setter.pageTable,
                // toolbar: '#PlacardHeaderToolbar',
                defaultToolbar: [],
                loading: false,
                cols: cols
            });

            table.on('tool(tableSlideshow)', function (obj) {
                console.log(obj);
                layui.data('currentSlideshow', {
                    key: 'id',
                    value: obj.data.id
                });
                var layEvent = obj.event;

                if (layEvent === 'edit') {
                    admin.popupCenter({
                        id: 'LAY_adminPopupSlideshowEdit',
                        title: '编辑轮播图',
                        //area:['821px', '522px'],
                        area: ['821px', '55.12%'],
                        success: function () {
                            view(this.id).render('/setting/system/menu/slideshow-edit');
                        }
                    });
                } else if (layEvent === 'delete') {
                    var idList = [];
                    idList.push(obj.data.id);
                    layer.confirm('是否删除该轮播图', {icon: 3, title: '提示'}, function () {
                        admin.req({
                            url: setter.baseUrl + '/system/placards',
                            type: 'delete',
                            data: {idList: idList},
                            done: function (res) {
                                layer.msg(res.message, {icon: 1, time: 1000}, function () {
                                    reloadTable();
                                });
                            }
                        });
                    });
                }
            });

            //批量操作
            function getMemberId(name) {
                var parameter = [];
                var checkStatus = table.checkStatus('tableSlideshow'), data = checkStatus.data;
                for (var i in data) {
                    parameter.push(data[i][name]);
                }
                return parameter;
            }

            // 添加轮播图事件  
            $(document).off('click', '#deletePlacard');
            $(document).on('click', '#deletePlacard', function () {
                var idList = getMemberId('id');
                alert(idList);
                if (!idList.length) {
                    layer.alert('请选择要操作的商品', {icon: 5});
                    return;
                } else {
                    layer.confirm('是否批量删除', {icon: 3, title: '提示'}, function () {
                        admin.req({
                            url: setter.baseUrl + '/system/placards',
                            type: 'delete',
                            data: {idList: idList},
                            done: function (res) {
                                layer.msg(res.message, {icon: 1, time: 1000}, function () {
                                    reloadTable();
                                });
                            }
                        });
                    });
                }
            });

            // 批量删除事件
            $(document).off('click', '#addPlacard');
            $(document).on('click', '#addPlacard', function () {
                admin.popupCenter({
                    id: 'LAY_adminPopupSlideshowAdd',
                    title: '添加轮播图',
                    //area:['821px', '522px'],
                    area: ['821px', '55.12%'],
                    success: function () {
                        view(this.id).render('/setting/system/menu/addplacard');
                    }
                });
            });

            //关闭弹窗
            $(document).off('click', '#cancel');
            $(document).on('click', '#cancel', function () {
                console.log(admin.popup.index);
                layer.close(admin.popup.index);
            });

            //点击添加轮播图

            //批量删除轮播图
            /*    $('#batchDelete').click(function () {
                    if (!operateIdList.length) {
                        layer.alert('请选择要操作的商品', {icon: 5});
                        return;
                    } else {
                        layer.confirm('是否批量删除', {icon: 3, title: '提示'}, function () {
                            admin.req({
                                url: setter.baseUrl + '/manage/mango-slide/delete',
                                type: 'delete',
                                data: {idData: operateIdList},
                                done: function (res) {
                                    layer.msg(res.message, {icon: 1, time: 1000}, function () {
                                        reloadTable();
                                    });
                                }
                            });
                        });
                    }
                });*/

            //确认添加轮播图
            form.on('submit(add-slideshow)', function (obj) {
                console.log(obj);
                if (!obj.field.imageUrl) {
                    layer.alert('请添加轮播图', {icon: 5});
                    return;
                }
                admin.req({
                    url: setter.baseUrl + '/system/placard',
                    type: 'post',
                    data: obj.field,
                    done: function (res) {
                        layer.msg(res.message, {icon: 1, time: 1000}, function () {
                            layer.closeAll();
                            reloadTable();
                        });
                    }
                });
            });

            //确认修改轮播图
            form.on('submit(edit-slideshow)', function (obj) {
                console.log(obj);
                if (!obj.field.imageUrl) {
                    layer.alert('请添加轮播图', {icon: 5});
                    return;
                }
                admin.req({
                    url: setter.baseUrl + '/system/placard/' + layui.data('currentSlideshow').id,
                    type: 'put',
                    data: obj.field,
                    done: function (res) {
                        layer.msg(res.message, {icon: 1, time: 1000}, function () {
                            layer.closeAll();
                            reloadTable();
                        });
                    }
                });
            });

            function reloadTable() {
                table.reload('tableSlideshow', {
                    url: setter.baseUrl + '/system/placards',
                    response: setter.responseTable,
                    page: setter.pageTable,
                    loading: false,
                    // toolbar: '#PlacardHeaderToolbar',
                    defaultToolbar: [],
                    cols: cols
                });
            }

            getSpecialtyNum();

            function getSpecialtyNum() {
                admin.req({
                    url: setter.baseUrl + '/system/placards',
                    type: 'get',
                    // data: data,
                    done: function (res) {
                        $('#specialty').val(res.count);
                    }
                });
            }
        });
    });
</script>