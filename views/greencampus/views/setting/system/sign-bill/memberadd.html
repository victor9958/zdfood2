<!-- 签单人添加页面 -->
<style>
    .wrapper .layui-input-inline {
        margin-bottom: 12px;
    }

    .wrapper .header {
        padding-left: 10px;
        border-left: 4px solid #06ccc5;
        line-height: 1;
        color: #999;
        margin-bottom: 20px;
        margin-top: 30px;
    }

    .btn-bar {
        background: #f7f8fa;
        padding: 4px 10px;
    }

    .active {
        background: #F6F6F6;
    }

    .pay .list-wrapper li {
        padding: 6px;
        line-height: 30px;
    }

    #iphone {
        position: relative;
    }

    #iphone .search {
        position: absolute;
        width: 99.7%;
        max-height: 500px;
        background-color: #fff;
        z-index: 9999;
        border: 1px solid #e6e6e6;
        margin-top: 6px;
        border-radius: 4px;
    }

    #iphone .search .search-list {
        height: 38px;
        line-height: 38px;
        padding: 0 12px;
        /*border-bottom: 1px solid #E6E6E6;*/
    }

    /*  #iphone .search .search-list:last-child {
          border-bottom: none;
      }*/


</style>
<title>签单人</title>
<div class='wrapper layui-fluid full-height '>
    <div class='layui-card full-height over-auto'>
        <!-- //上面的head，标题 -->
        <div class="layui-card-header">签单人</div>
        <!-- //content身体部分 -->
        <div class='layui-card-body'>
            <div class="layui-form layui-form-pane" lay-filter="formTest">
                <div class="layui-form-item">
                    <div class="layui-block" pane>
                        <label class="layui-form-label">所属校区</label>
                        <div class="layui-input-block">
                            <script type="text/html" template lay-url="{{layui.setter.baseUrl}}/system/site/campuses"
                                    lay-done="{{layui.form.render()}}">
                                <select name="campusId" id="" lay-filter="campus">
                                    <option value="" disabled selected>请选择校区</option>
                                    {{#
                                    layui.each(d.data, function(index, item){
                                    }}
                                    <option value="{{item.id}}">{{item.name}}</option>
                                    {{# }) }}
                                </select>
                            </script>
                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-block" pane>
                        <label class="layui-form-label">签单单位</label>
                        <div class="layui-input-block">
                            <script type="text/html" template
                                    lay-url="{{layui.setter.baseUrl}}/system/site/units?withoutPage=1"
                                    lay-done="{{layui.form.render()}}">
                                <select name="unitId" id="sign_unit_id" lay-filter="campus">
                                    <option value="" disabled selected>请选择签单单位</option>
                                    {{#
                                    layui.each(d.data, function(index, item){
                                    }}
                                    <option value="{{item.id}}">{{item.name}}</option>
                                    {{# }) }}
                                </select>
                            </script>
                        </div>
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-block" pane>
                        <label class="layui-form-label">手机号码</label>
                        <div class="layui-input-block" id="iphone">
                            <input type="text" lay-verify="required" id="phoneNumber" name="mobile"
                                   class="remark layui-input"
                                   placeholder="请输入手机号码">
                            <div class="search hide">

                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-block">
                        <label class="layui-form-label">学工号</label>
                        <div class="layui-input-block">
                            <input type="text" name="job_no" id="" class="remark layui-input" placeholder="请输入学工号"
                                   readonly>
                        </div>
                    </div>
                </div>
                <input type="hidden" name="userId" value="">

                <div class="layui-form-item">
                    <div class="layui-block" pane>
                        <label class="layui-form-label">姓名</label>
                        <div class="layui-input-block">
                            <input type="text" name="name" value="" class="layui-input" placeholder="请输入姓名" readonly>
                        </div>
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-block" pane>
                        <label class="layui-form-label">职务</label>
                        <div class="layui-input-block">
                            <input type="text" name="contactPhone" class="layui-input" placeholder="请输入职务" readonly>
                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-block" pane>
                        <label class="layui-form-label">电子邮箱</label>
                        <div class="layui-input-block">
                            <input type="text" name="email" class="layui-input" placeholder="请输入电子邮箱">
                        </div>
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-block" pane>
                        <label class="layui-form-label">联系地址</label>
                        <div class="layui-input-block">
                            <input type="text" lay-verify="required" name="address" class="layui-input"
                                   placeholder="请输入联系地址">
                        </div>
                    </div>
                </div>

                <!-- 确定和取消按钮 -->
                <div class="layui-input-inline ">
                    <button class="layui-btn" lay-submit id="confirm" lay-filter="confirm">保存</button>
                    <button class="layui-btn" lay-submit id='cancel' lay-filter="cancel">取消</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>


    layui.use(['admin', 'form', 'laydate', 'table'], function () {
        var $ = layui.$,
            admin = layui.admin,
            table = layui.table,
            view = layui.view,
            setter = layui.setter,
            form = layui.form,
            laydate = layui.laydate,
            upload = layui.upload;

        $(function () {

            var userId = layui.data('userId').id;
            if (userId) {
                admin.req({
                    url: setter.baseUrl + '/user/' + userId
                    , type: 'GET'
                    , data: {unitCampusId: 1}
                    , done: function (res) {
                        form.val("formTest", {
                            "job_no": res.data.student_num
                            , "name": res.data.name
                            , "contactPhone": res.data.position
                            , "email": res.data.email
                            , "userId": res.data.id
                            , "mobile": res.data.mobile
                            , "unitId": res.data.unit_id
                            , "address": res.data.address
                            , "campusId": res.data.campusId
                        })
                    }
                });
            }

            $('#phoneNumber').bind('input propertychange', function () {
                var query = $(this).val()
                if (query) {
                    getData(query)
                } else {
                    $('.search').addClass('hide');
                }
            })

            $('.search').on('click', '.search-list', function () {
                var phone = $(this).text();
                $('#phoneNumber').val(phone);
                $('.search').addClass('hide');
                getData(phone)
            })

            function getData(query) {
                admin.req({
                    url: setter.baseUrl + '/dim-users'
                    , type: 'get'
                    , data: {'query': query}
                    , done: function (res) {
                        // console.log(res.data[0].job_no);
                        if (res.data.length > 0) {
                            $('.search').removeClass('hide');
                            var _html = ''
                            $.each(res.data, function (i, k) {
                                _html += '<div class="search-list">' + k.mobile + '</div>'
                            })
                            $('.search').html(_html);
                            var phone_test = /^[1][3-9][0-9]{9}$/;
                            if (phone_test.test(query) && res.data.length == 1) {
                                form.val("formTest", {
                                    "job_no": res.data[0].student_num
                                    , "name": res.data[0].name
                                    , "contactPhone": res.data[0].position
                                    , "email": res.data[0].email
                                    , "userId": res.data[0].id
                                })
                                $('.search').addClass('hide');
                            }
                        } else {
                            $('.search').addClass('hide');
                        }
                    }
                });
            }

            form.on('submit(confirm)', function (obj) {
                if (!obj.field.campusId) {
                    layer.msg('请选择所属校区', {icon: 5, time: 2000})
                } else if (!obj.field.unitId) {
                    layer.msg('请选择签单单位', {icon: 5, time: 2000})
                } else {
                    admin.req({
                        url: setter.baseUrl + '/system/site/sign-bill-user'
                        , type: 'post'
                        , data: obj.field
                        , done: function (res) {
                            layer.msg(res.message, {icon: 1, time: 2000}, function () {
                                layer.close(admin.popup.index);//关闭右侧面板
                                window.location.hash = '#/setting/system/sign-bill/member';
                            });

                        }
                    });
                }
            });
            $(document).on('click', '#cancel', function () {
                window.location.hash = '#/setting/system/sign-bill/member';
            });
        });
    });

</script>