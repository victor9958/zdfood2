<title>用户详情</title>
<div class="layui-fluid layui-border-box full-height user-detail">
    <div class="layui-row full-height">
        <div class="layui-card full-height flex flex-v">
            <div class="layui-card-header">
                用户详情
            </div>
            <div class="layui-card-body flex-1 over-auto">
                <div class="layui-form layui-form-pane full-height flex flex-v">
                    <script type="text/html" template
                            lay-url="{{layui.setter.baseUrl + '/user-manage/role/user/'+layui.data('currentId').id}}"
                            lay-done="{{layui.form.render();}}">
                        <div class="layui-clear flex-1">
                            <div class="layui-form-item">
                                <label class="layui-form-label">姓名</label><!--<span class="important">*</span>-->
                                <div class="layui-input-block">
                                    <input type="text" name="name" lay-verify="required" autocomplete="off"
                                           value="{{ d.data.user.name }}" placeholder="请输入姓名（必填）" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">手机号</label>
                                <div class="layui-input-block">
                                    <input type="text" name="mobile" lay-verify="phone" autocomplete="off"
                                           value="{{ d.data.user.mobile }}" placeholder="请输入手机号（必填）"
                                           class="layui-input">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">学号/工号</label>
                                <div class="layui-input-block">
                                    <input type="text" name="jobNumber" lay-verify="required" autocomplete="off"
                                           value="{{ d.data.user.job_number }}" placeholder="请输入工号（必填）"
                                           class="layui-input">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">角色</label>
                                <div class="layui-input-block">
                                    <input type="text" autocomplete="off" value="{{ d.data.user.role.role_name }}" class="layui-input" readonly>
                                </div>
                            </div>
                            <!--<div class="layui-form-item layui-col-xs6">-->
                            <!--<label class="layui-form-label left">组织架构</label>-->
                            <!--<div class="layui-input-block">-->
                            <!--<input type="text" name="post_name" lay-verify="required" autocomplete="off"-->
                            <!--value="{{ d.data.user.structureName }}" placeholder="请输入岗位（必填）" class="layui-input">-->
                            <!--</div>-->
                            <!--</div>-->
                            {{# layui.each(d.data.structureData,function(index,item){ }}
                            <div class="layui-form-item">
                                <label class="layui-form-label">{{ item.title }}</label>
                                <div class="layui-input-block">
                                    <select name="structureId" lay-filter="structure">
                                        <option value=""></option>
                                        {{#
                                        layui.each(item.all,function(index2,item2){
                                        if(item.structure != null){
                                        if(item2.id === item.structure.id){
                                        }}
                                        <option value="{{ item2.id }}" selected>{{ item2.name }}</option>
                                        {{# }else{ }}
                                        <option value="{{ item2.id }}">{{ item2.name }}</option>
                                        {{#
                                        }
                                        }else{
                                        }}
                                        <option value="{{ item2.id }}">{{ item2.name }}</option>
                                        {{#
                                        }
                                        })
                                        }}
                                    </select>
                                </div>
                            </div>
                            {{# }) }}
                            {{# layui.each(d.data.extendsData,function(index,item){
                            if(item.option_type === 1){
                            }}
                            <div class="layui-form-item">
                                <label class="layui-form-label">{{ item.title }}</label>
                                <div class="layui-input-block">
                                    <input type="text" name="extends" id="{{ item.id }}" autocomplete="off"
                                           value="{{ item.value!=null?item.value:'' }}"
                                           placeholder="请输入{{ item.title }}" class="layui-input">
                                </div>
                            </div>
                            {{# }else if(item.option_type === 3){ }}
                            <div class="layui-form-item">
                                <label class="layui-form-label">{{ item.title }}</label>
                                <div class="layui-input-block">
                                    <select name="extends" id="{{ item.id }}">
                                        <option value="">请选择{{ item.title }}</option>
                                        {{#
                                        layui.each(item.option_set,function(index2,item2){
                                        if(item2 === item.value){
                                        }}
                                        <option value="{{ item2 }}" selected>{{ item2 }}</option>
                                        {{# }else{ }}
                                        <option value="{{ item2 }}">{{ item2 }}</option>
                                        {{#
                                        }
                                        })
                                        }}
                                    </select>
                                </div>
                            </div>
                            {{# }else if(item.option_type === 2){ }}
                            <div class="layui-form-item" pane="">
                                <label class="layui-form-label">{{ item.title }}</label>
                                <div class="layui-input-block">
                                    <textarea type="text" name="extends" id="{{ item.id }}" autocomplete="off"
                                              placeholder="请输入{{ item.title }}" class="layui-textarea">{{ item.value!=null?item.value:'' }}</textarea>
                                </div>
                            </div>
                            {{#
                            }
                            })
                            }}
                        </div>
                        <div class="layui-form-item p-t-10">
                            <button class="layui-btn" lay-submit lay-filter="LAY-edit-user-submit">修改</button>
                            <a href="javascript:history.go(-1);" class="layui-btn layui-btn-primary">取消</a>
                        </div>
                    </script>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    layui.use('form', function () {
        var $ = layui.$,
            form = layui.form,
            setter = layui.setter,
            admin = layui.admin;

        //修改用户信息
        form.on('submit(LAY-edit-user-submit)', function (obj) {
            obj.field.extends = {};
            $('*[name="extends"]').each(function (i, k) {
                obj.field.extends[k.id] = k.value;
            })
            $('*[name="structureId"]').each(function (i, k) {
                if (k.value != '') {
                    obj.field.structureId = k.value;
                }
            })
            console.log(obj.field)
            admin.req({
                url: setter.baseUrl + '/user-manage/role/user/' + layui.data('currentId').id
                , type: 'put'
                , data: obj.field
                , done: function (res) {
                    //关闭右侧面板
                    layer.msg(res.message, {icon: 1, time: 1000}, function () {
                        location.hash = '/setting/user/role'
                    });
                }
            });
        });


        var selectVal = '';
        form.on('select(structure)', function (data) {
            console.log($(data.elem).text().trim()); //得到select原始DOM对象
            console.log(data.value); //得到被选中的值
            console.log(data.othis); //得到美化后的DOM对象

            var currentVal = $(data.elem).text().trim();
            if (currentVal != selectVal || !data.value) {
                $(data.elem).parents('.layui-form-item').nextAll().find('select').html('');
                if (data.value != '') {
                    admin.req({
                        url: setter.baseUrl + '/user-manage/roles/structure/' + data.value + '/sons'
                        , type: 'get'
                        , data: {}
                        , done: function (res) {
                            if (res.data.length > 0) {
                                var html = '<option value="">请选择</option>';
                                $.each(res.data, function (index, item) {
                                    html += '<option value="' + item.id + '">' + item.name + '</option>';
                                })
                                console.log(html)
                                $(data.elem).parents('.layui-form-item').next().find('select').html(html);
                                form.render();
                            }
                            // layer.msg(res.message, {icon: 1, time: 1000});
                        }
                    });
                }
                form.render();
            }
        });

        $(document).off('click', '.layui-form-select');
        $(document).on('click', '.layui-form-select', function () {
            selectVal = $(this).find('input').val();
            console.log(selectVal)
        })

    });

</script>