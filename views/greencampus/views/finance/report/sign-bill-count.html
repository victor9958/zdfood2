<style>
    .btn-bar {
        background: #f7f8fa;
        padding: 4px 10px;
    }
    .ml {
        margin-left: 10px;
    }
</style>
<!-- 签单支付统计 -->
<title>签单支付统计</title>
<div class="layui-fluid full-height">
    <div class="layui-card full-height over-auto">
        <div class="layui-card-header">签单支付统计</div>
        <div class="layui-card-body">
            <fieldset class="layui-elem-field">
                <legend>搜索条件</legend>
                <div class="layui-form">
                    <div class="layui-form-item">
                        <!-- 下拉列表模板渲染 -->
                        <div class="layui-inline">
                            <script type="text/html" template lay-url="{{layui.setter.baseUrl}}/system/site/campuses"
                                lay-done="{{layui.form.render()}}">
                                <select name="campus_id" id="campus" lay-filter="campus">
                                    <option value="" disabled selected>请选择校区</option>
                                    {{# layui.each(d.data, function(index, item){ }}
                                    <option value="{{item.id}}">{{item.name}}</option>
                                    {{# }); }}
                                </select>
                            </script>
                        </div>
                        <div class="layui-inline">
                            <!-- <script type="text/html" template lay-url="{{layui.setter.baseUrl}}/system/site/units?withoutPage=1"
                                lay-done="{{layui.form.render()}}"> -->
                            <select name="sign_unit_id" id="branch" lay-filter="branch">
                                <option value="" disabled selected>请选择签单部门</option>
                                <!-- {{# layui.each(d.data, function(index, item){ }}
                                    <option value="{{item.id}}">{{item.name}}</option>
                                    {{# }); }}  -->
                            </select>
                            <!-- </script> -->
                        </div>
                        <div class="layui-inline">
                            <input type="text" class="layui-input time" id="orderListdate" placeholder="请选择时间段">
                            <input type="hidden" name="start_time" id="orderListStartTime" value="">
                            <input type="hidden" name="end_time" id="orderListEndTime" value="">
                        </div>
                        <div class="layui-inline">
                            <button class="layui-btn" lay-submit lay-filter="search">查询</button>
                            <!-- <script type="text/html" template>
                                <a href="{{layui.setter.baseUrl}}/finance/sign-pay-statistics-export?Authorization={{layui.data('layuiAdmin').Authorization}}"
                                class="layui-btn ml">导出</a>
                            </script> -->

                            <!-- <div class="layui-inline"> -->
                                    <a href="javascript:;" class="layui-btn layui-btn-normal" lay-submit lay-filter="LAY-report-sign-bill-count">导出Excel</a>
                            <!-- </div> -->
                            
                                    <a href="javascript:;" class="layui-btn layui-btn-normal" lay-submit lay-filter="LAY-report-sign-bill-count-print">打印</a>
                         
                        </div>
                    </div>
                </div>
            </fieldset>
            <!-- <div class="m-b-10 btn-bar">
                
                
            </div> -->
            <!-- 财务报表详情 -->
            <table class="layui-hide" id="repCount" lay-filter="repCount"></table>
            <script type="text/html" id="particulars">
                <a class="layui-btn layui-btn-xs" lay-event="detail">详情</a>
            </script>
        </div>
    </div>
</div>

<script>
    layui.use(['admin', 'form', 'table', 'laydate'], function () {
        var $ = layui.$,
            admin = layui.admin,
            view = layui.view,
            setter = layui.setter,
            form = layui.form,
            laydate = layui.laydate,
            table = layui.table,
            upload = layui.upload,
            laydate = layui.laydate;

        $(function () {
            var cols = [[ //表头
                { field: 'sign_unit_name', title: '单位' }
                , { field: 'sign_count', title: '签单笔数' }
                , { field: 'sign_pay_count', title: '签单金额' }
                , { field: 'yes_pay', title: '已付金额' }
                , { field: 'not_pay', title: '未付金额' }
                , { title: '操作', align: 'center', toolbar: '#particulars' }
            ]];
            table.render(
                {
                    elem: '#repCount'
                    , url: setter.baseUrl + '/finance/sign-pay-statistics'
                    , response: setter.responseTable
                    , page: setter.pageTable
                    , cols: cols
                }
            );
            // 时间控件
            laydate.render({
                elem: '#orderListdate' //指定元素
                , type: 'date'
                , range: '-'
                , done: function (value, date, endDate) {
                    console.log(value);
                    // 获取到的日期格式进行分割2018-10-09 - 2018-11-21
                    var beginTime = value.split(' - ')[0];
                    var endTime = value.split(' - ')[1];
                    $('#orderListStartTime').val(beginTime);
                    $('#orderListEndTime').val(endTime);
                }
            });

            //查询按钮
            form.on('submit(search)', function (obj) {
                console.log(obj);
                table.reload('repCount', {
                    url: setter.baseUrl + '/finance/sign-pay-statistics',
                    response: setter.responseTable,
                    page: setter.pageTable,
                    cols: cols,
                    where: obj.field
                });
            });

            // 监听工具条的点击事件
            table.on('tool(repCount)', function (obj) { //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
                var data = obj.data; //获得当前行数据
                var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
                var tr = obj.tr; //获得当前行 tr 的DOM对象

                console.log(obj.data.id);
                layui.data('orderIdd', {
                    key: 'id',
                    value: obj.data.id
                });

                if (layEvent === 'detail') { //查看detail
                    window.location.hash = '#/finance/report/sign-bill-countXq';
                }
            });

            // 通过校区ID去查签单单位
            //获取食堂
            form.on('select(campus)', function (data) {
                var campusId = data.value;
                admin.req({
                    url: setter.baseUrl + '/system/site/units?withoutPage=1',
                    type: 'get',
                    data: { campusId: campusId },
                    done: function (res) {
                        var _html = '<option value="" disabled selected>请选择签单部门</option>';
                        $.each(res.data, function (i, k) {
                            _html += '<option value="' + k.id + '">' + k.name + '</option>'
                        })
                        $('#branch').html(_html)
                        form.render();
                    }
                });
            });





            
            function deviceExport(filter, url, deviceType) {
                form.on(filter, function (obj) {
                    console.log(obj);
                    var href = setter.baseUrl + url + '?Authorization=' + layui.data('layuiAdmin').Authorization + '&campus_id=' +
                        obj.field.campus_id + '&sign_unit_id=' + obj.field.sign_unit_id + '&start_time=' + obj.field.start_time + '&end_time=' +
                        obj.field.end_time ;
                    window.location.href = href;
                });
            };
            deviceExport('submit(LAY-report-sign-bill-count)', '/finance/sign-pay-statistics-export', 3);

             deviceExport('submit(LAY-report-sign-bill-count-print)', '/finance/sign-pay-statistics-print', 3);

        });
    });
</script>