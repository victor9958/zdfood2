<style>
    .btn-bar {
        background: #f7f8fa;
        padding: 4px 10px;
    }

    .layui-card-body{
        height: 100%;
    }
    .ml {
        margin-left: 10px;
    }
</style>
<!-- 外卖汇总 -->
<title>外卖汇总</title>
<div class="layui-fluid full-height">
    <div class="layui-card full-height over-auto">
        <div class="layui-card-header">外卖汇总</div>
        <div class="layui-card-body  over-auto">
            <fieldset class="layui-elem-field">
                <legend>搜索条件</legend>
                <div class="layui-form">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <!-- 下拉列表模板渲染  -->
                            <div class="layui-input-inline">
                                <script type="text/html" template
                                        lay-url="{{layui.setter.baseUrl}}/system/site/campuses"
                                        lay-done="{{layui.form.render()}}">
                                    <select name="campus_id" id="campus" lay-filter="campus">
                                        <option value="" disabled selected>请选择校区</option>
                                        {{# layui.each(d.data, function(index, item){ }}
                                        <option value="{{item.id}}">{{item.name}}</option>
                                        {{# }); }}
                                    </select>
                                </script>
                            </div>
                            <div class="layui-inline ">
                                <button class="layui-btn " lay-submit lay-filter="search">查询</button>
                                <!-- <script type="text/html" template>
                                    <a href="{{layui.setter.baseUrl}}/finance/order-rate-export?eat_type=1?Authorization={{layui.data('layuiAdmin').Authorization}}"
                                       class="layui-btn  ml">导出</a>
                                </script>
                                <script type="text/html" template>
                                    <a href="{{layui.setter.baseUrl}}/finance/order-rate-print?eat_type=1?Authorization={{layui.data('layuiAdmin').Authorization}}"
                                       class="layui-btn  ml">打印</a>
                                </script> -->
                            </div>
                                <div class="layui-inline">
                                    <a href="javascript:;" class="layui-btn layui-btn-normal" lay-submit lay-filter="LAY-collect-export">导出Excel</a>
                                </div>
                                <!-- <script type="text/html" template>
                                    <a href="{{layui.setter.baseUrl}}/finance/order-rate-print?eat_type=2?Authorization={{layui.data('layuiAdmin').Authorization}}"
                                    class="layui-btn ml">打印</a>
                                </script> -->
                                <div class="layui-inline">
                                    <a href="javascript:;" class="layui-btn layui-btn-normal" lay-submit lay-filter="LAY-collect-print">打印</a>
                                </div>
                            
                        </div>
                    </div>
                </div>
            </fieldset>
            <!-- <div class="m-b-10 btn-bar">
                
            </div> -->
            <!-- 财务报表详情 -->
            <table class="layui-hide" id="repLect-out" lay-filter="repLect-out"></table>
            <script type="text/html" id="orderOperate-out">
                <a class="layui-btn layui-btn-xs layui-btn " lay-event="readPig-out">查看图标</a>
            </script>
        </div>
    </div>
</div>
<script>
    layui.use(['admin', 'form', 'table', 'laydate'], function () {
        var $ = layui.$,
            admin = layui.admin,
            view = layui.view,
            setter = layui.setter,
            form = layui.form,
            laydate = layui.laydate,
            table = layui.table,
            upload = layui.upload,
            laydate = layui.laydate;
        $(function () {
            var cols = [[ //表头
                {field: 'campus_name', title: '校区'}
                , {field: 'order_count', title: '外卖订单数'}
                , {field: 'already_num', title: '完成配送'}
                , {field: 'price_count', title: '金额'}
                , {field: 'already_portion', title: '进度'}
                , {title: '详情', align: 'center', toolbar: '#orderOperate-out'}
            ]];
            table.render(
                {
                    elem: '#repLect-out'
                    , url: setter.baseUrl + '/finance/order-rate?eat_type=1'
                    , response: setter.responseTable
                    , page: setter.pageTable
                    , cols: cols
                }
            );

            // 时间控件
            laydate.render({
                elem: '#orderListdate' //指定元素
                , type: 'date'
                , range: '-'
                , done: function (value, date, endDate) {
                    console.log(value);
                    // 获取到的日期格式进行分割2018-10-09 - 2018-11-21
                    var beginTime = value.split(' - ')[0];
                    var endTime = value.split(' - ')[1];
                    $('#orderListStartTime').val(beginTime);
                    $('#orderListEndTime').val(endTime);
                }
            });


            //点击搜索订单
            var object = {};
            form.on('submit(search)', function (obj) {
                object = obj.field;
                console.log(obj);
                table.reload('repLect-out', {
                    url: setter.baseUrl + '/finance/order-rate?eat_type=1',
                    response: setter.responseTable,
                    page: setter.pageTable,
                    cols: cols,
                    where: obj.field
                });
            });
            // 监听工具条的点击事件campus_id
            table.on('tool(repLect-out)', function (obj) {
                var data = obj.data;
                var layEvent = obj.event;
                var tr = obj.tr;
                if (layEvent == 'readPig-out') {
                    // console.log( obj.data)
                    layui.data('campus_id', {
                        key: 'id',
                        value: obj.data.campus_id
                    });
                    admin.popupCenter({
                        id: 'Out-chart'
                        , title: '查看图标'
                        , area: ['500px', '440px']
                        , success: function () {
                            view(this.id).render('/finance/report/Out-chart');
                        }
                    });
                }
            });
            function deviceExport(filter, url, deviceType) {
                form.on(filter, function (obj) {
                    console.log(obj);
                    var href = setter.baseUrl + url + '?eat_type=2&Authorization=' + layui.data('layuiAdmin').Authorization + '&campus_id=' +
                        obj.field.campus_id  ;
                    window.location.href = href;
                    // alert(href);
                });
            };
            // 导出
            deviceExport('submit(LAY-collect-export)', '/finance/order-rate-export?eat_type=1', 3);
            // 打印
            deviceExport('submit(LAY-collect-print)', '/finance/order-rate-print?eat_type=1', 3);
        });
    });
</script>