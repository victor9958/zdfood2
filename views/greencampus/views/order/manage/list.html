<!-- 订单管理 -->
<style>
    .wrapper .layui-input-inline {
        margin-bottom: 12px;
    }
</style>
<title>订单管理</title>
<div class='wrapper layui-fluid full-height '>
    <div class='layui-card full-height over-auto'>
        <!-- //上面的head，标题 -->
        <div class="layui-card-header">订单管理</div>
        <!-- //content身体部分 -->
        <div class='layui-card-body'>
            <fieldset class="layui-elem-field">
                <legend>搜索条件</legend>
                <div class="layui-form">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <div class="layui-input-inline">
                                <input type="text" name="name_or_mobile" class="layui-input" placeholder="请输入姓名/手机号">
                            </div>
                            <div class="layui-input-inline">
                                <script type="text/html" template lay-url="{{layui.setter.baseUrl}}/system/site/campuses"
                                    lay-done="layui.data.done(d)">
                                    <select name="campus_id" id="" lay-filter="campus">
                                        <option value="" disabled selected>请选择校区</option>
                                        {{#
                                        layui.each(d.data, function(index, item){
                                        }}
                                        <option value="{{item.id}}">{{item.name}}</option>
                                        {{# }) }}
                                    </select>
                                </script>
                            </div>
                            <div class="layui-input-inline">
                                <select name="canteen_id" id="canteenV">
                                    <option value="" disabled selected>请选择食堂</option>
                                </select>
                            </div>
                            <div class="layui-input-inline">
                                <script type="text/html" template lay-url="{{layui.setter.baseUrl}}/system/site/areas?withoutPage=1"
                                    lay-done="layui.data.done(d)">
                                    <select name="area_id" id="">
                                        <option value="" disabled selected>请选择区域</option>
                                        {{#
                                        layui.each(d.data, function(index, item){
                                        }}
                                        <option value="{{item.id}}">{{item.name}}</option>
                                        {{# }) }}
                                    </select>
                                </script>
                            </div>
                            <div class="layui-input-inline">
                                <select name="repast_way" id="">
                                    <option value="" disabled selected>请选择就餐方式</option>
                                    <option value="1">外卖</option>
                                    <option value="2">堂食</option>
                                </select>
                            </div>
                            <div class="layui-input-inline">
                                <select name="pay_type" id="">
                                    <option value="" disabled selected>请选择支付方式</option>
                                    <option value="1">一卡通支付</option>
                                    <option value="2">签单</option>
                                </select>
                            </div>
                            <div class="layui-input-inline">
                                <select name="status" id="">
                                    <option value="" disabled selected>请选择发货状态</option>
                                    <option value="1">生产中</option>
                                    <option value="2">待核销</option>
                                    <option value="3">已过期</option>
                                    <option value="4">已核销</option>
                                    <option value="5">带配送</option>
                                    <option value="6">配送中</option>
                                    <option value="7">配送完成</option>
                                    <option value="8">已取消</option>
                                </select>
                            </div>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input time" id="orderListdate" placeholder="请选择开始时间和结束时间">
                                <input type="hidden" name="start_time" id="orderListStartTime" value="">
                                <input type="hidden" name="end_time" id="orderListEndTime" value="">
                            </div>
                            <div class="layui-inline">
                                <button class="layui-btn" lay-submit lay-filter="search">查询</button>
                                <!-- <button class="layui-btn" lay-submit lay-filter="set">导出</button> -->
                                <!-- <script type="text/html" template>
                                        <a href="{{layui.setter.baseUrl}}/order/export?Authorization={{layui.data('layuiAdmin').Authorization}}"
                                           class="layui-btn">导出表格</a>
                                    </script> -->
                                <a href="javascript:;" class="layui-btn layui-btn-normal" lay-submit lay-filter="LAY-manage-list">导出Excel</a>

                            </div>
                            <!-- <div class="layui-inline"> -->

                            <!-- </div> -->
                        </div>
                    </div>
                </div>
            </fieldset>
            <!-- 数据表格 -->
            <table id="orderListTable" lay-filter="orderListTable"></table>
            <script type="text/html" id="toolbar">
                <a class="layui-btn layui-btn-xs" lay-event="detail">详情</a>
 
                {{#   if(d.status==1&&d.pay_status ==1&&d.pay_type==1){  }}
                


                 


                <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">取消订单</a>

                {{# }else { }}
                {{#   } }}

            </script>
        </div>
    </div>
</div>
<script>
    layui.data.done = function (d) {
        layui.use(['admin', 'form', 'laydate', 'table'], function () {
            var $ = layui.$,
                admin = layui.admin,
                table = layui.table,
                view = layui.view,
                setter = layui.setter,
                form = layui.form,
                laydate = layui.laydate,
                upload = layui.upload;
            form.render();
            laydate.render({
                elem: '#orderListdate',
                type: 'date',
                range: '-',
                done: function (value, date, endDate) {
                    console.log(value);
                    var beginTime = value.split(' - ')[0];
                    var endTime = value.split(' - ')[1];
                    $('#orderListStartTime').val(beginTime);
                    $('#orderListEndTime').val(endTime);
                }
            });
            // 数据表格的声明
            var cols = [[
                { field: 'user_name', title: '姓名', width: 80 },
                { field: 'user_mobile', title: '手机号', width: 150 },
                { field: 'discount_price', title: '金额' },
                {
                    field: 'repast_date', title: '就餐日期', templet: function (d) {
                        if (d.created_at == null) {
                            return ''
                        } else {
                            return d.created_at.split(' ')[0]
                        }
                    }
                },
                { field: 'meal_type_name', title: '就餐餐次' },
                { field: 'eat_type_name', title: '就餐方式' },
                { field: 'campus_name', title: '校区' },
                { field: 'build_name', title: '楼幢', width: 150 },
                { field: 'canteen_name', title: '食堂' },
                { field: 'pay_type_name', title: '支付方式' },
                { field: 'pay_status_name', title: '支付状态' },
                { field: 'status_name', title: '发货状态' },
                { title: '操作', align: 'center', toolbar: '#toolbar', width: '10%' }
            ]];
            // 初始化数据表格
            getInitialize();
            function getInitialize() {
                table.render({
                    elem: '#orderListTable',
                    url: setter.baseUrl + '/order/list',
                    response: setter.responseTable,
                    page: setter.pageTable,
                    loading: false,
                    cellMinWidth: 100,
                    cols: cols
                    // , done: function (res) {
                    //     // var status = $(this).cols.pay_type_name;
                        
                    //     // if(){

                    //     // }
                    //     console.log(1111);
                    //     console.log(status);
                    // }
                });
            }
            // status == 1 && pay_status == 1 && pay_type == 1

            //点击搜索订单
            form.on('submit(search)', function (obj) {
                console.log(obj);
                table.reload('orderListTable', {
                    url: setter.baseUrl + '/order/list',
                    response: setter.responseTable,
                    page: setter.pageTable,
                    cols: cols,
                    where: obj.field
                });
            });

            //点击编辑或取消订单
            table.on('tool(orderListTable)', function (obj) {
                console.log(obj.data.id);
                layui.data('orderId', {
                    key: 'id',
                    value: obj.data.id
                });
                var layEvent = obj.event;
                if (layEvent === 'detail') {
                    window.location.hash = '#/order/manage/orderdtail';
                } else if (layEvent === 'del') {

                    layer.confirm('确定要取消订单嘛?', { icon: 1, title: '提示' }, function (index) {
                        var order_id = obj.data.id;
                        admin.req({
                            url: setter.baseUrl + '/order/cancel/' + order_id
                            , type: 'put'
                            // , data: {order_id:1}
                            , data: { order_id: order_id }
                            , done: function (res) {
                                layer.msg(res.message, { icon: 1, time: 2000 });
                                layer.close(index);

                            }
                        });
                    });
                }
            })

            //获取食堂
            form.on('select(campus)', function (data) {
                var campusId = data.value;
                admin.req({
                    url: setter.baseUrl + '/system/site/canteens',
                    type: 'get',
                    data: { campusId: campusId },
                    done: function (res) {
                        var _html = '<option value="" disabled selected>请选择食堂</option>';
                        $.each(res.data, function (i, k) {
                            _html += '<option value="' + k.id + '">' + k.name + '</option>'
                        })
                        $('#canteenV').html(_html)
                        console.log(_html);
                        form.render();
                    }
                });
            });

            // 导出表格
            function deviceExport(filter, url, deviceType) {
                form.on(filter, function (obj) {
                    console.log(obj);
                    var href = setter.baseUrl + url + '?Authorization='
                        + layui.data('layuiAdmin').Authorization + '&name_or_mobile=' + obj.field.name_or_mobile + '&campus_id='
                        + obj.field.campus_id + '&canteen_id=' + obj.field.canteen_id + '&area_id=' + obj.field.area_id + '&repast_way='
                        + obj.field.repast_way + '&pay_type=' + obj.field.pay_type + '&status=' + obj.field.status + '&start_time=' + obj.field.start_time + '&end_time=' + obj.field.end_time;
                    window.location.href = href;
                    console.log(href);
                });
            };
            deviceExport('submit(LAY-manage-list)', '/order/export', 3);
        });
    }
</script>