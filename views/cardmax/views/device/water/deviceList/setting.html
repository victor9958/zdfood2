<style>
    .device-setting .imgbox {
        width: 100px;
        height: 100px;
        border-radius: 4px;
        border: 1px solid #e6e6e6;
    }
    .device-setting .imgbox.default {
        background: #ebebf2;
    }

    .device-setting .imgbox .icon {
        width: 30px;
        height: 30px;
    }

    .device-setting .layui-form-pane .not-pane-label {
        float: left;
        display: block;
        padding: 9px 15px;
        padding-left: 0;
        width: 80px;
        font-weight: 400;
        line-height: 20px;
    }

    .device-setting .layui-form-pane .layui-form-item[pane] .not-pane-inline {
        margin-left: 0;
        background: #FBFBFB;
    }

    .device-setting .layui-form-pane .layui-form-item[pane] .not-pane-inline .layui-form-mid {
        float: none;
        text-align: center;
    }

    .device-setting .layui-form-pane .layui-form-item[pane] .not-pane-inline .layui-input {
        border-radius: 4px;
    }
    .device-setting .hide{
        display: none;
    }
</style>
<title>设备参数配置</title>
<div class="layui-fluid full-height device-setting">
    <div class="layui-row full-height">
        <div class="layui-card full-height">
            <div class="layui-card-body full-height">
                <div class="layui-tab full-height flex flex-v">
                    <ul class="layui-tab-title">
                        <li class="layui-this">基础设备</li>
                        <li>硬件设置</li>
                    </ul>
                    <div class="layui-tab-content flex-1 over-auto">
                        <script type="text/html" template
                                lay-url="{{layui.setter.baseUrl}}/device-manage/drinks/param"
                                lay-data="{deviceIdList:layui.data('temporary').temporary}"
                                lay-done="{{layui.form.render();layui.admin.device.uploadImg();}}">
                            <div class="layui-tab-item layui-show full-height">
                                <div class="layui-form layui-form-pane full-height flex flex-v">
                                    <div class="layui-clear flex-1">
                                        <div class="layui-form-item" pane="">
                                            <label class="layui-form-label">上传图片</label>
                                            <div class="layui-input-block block-blank">
                                                <div class="m-b-10 ft-gray">
                                                    <img class="imgbox {{d.data != null && d.data.icon_url != ''?'':'hide'}} img_{{ layui.data('temporary').temporary.length === 1? layui.data('temporary').temporary:0}}"
                                                         src="{{d.data != null && d.data.icon_url != ''?d.data.icon_url:''}}">
                                                    <div class="imgbox default {{ d.data == null || (d.data != null && d.data.icon_url== '') ?'':'hide'}} flex flex-v flex-align-center flex-pack-center">
                                                        <svg class="icon ft-gray" aria-hidden="true">
                                                            <use xlink:href="#icon-tupian"></use>
                                                        </svg>
                                                        100 X 100px
                                                    </div>
                                                    <input type="hidden" value="{{d.data != null && d.data.icon_url != ''?d.data.icon_url:''}}"
                                                           class="layui-input icon_url content_{{ layui.data('temporary').temporary.length === 1? layui.data('temporary').temporary:0}}">
                                                </div>
                                                <div class="m-b-10">
                                                    <button class="layui-btn upload_img"
                                                            data-id="{{ layui.data('temporary').temporary.length === 1? layui.data('temporary').temporary:0}}">
                                                        上传图片
                                                    </button>
                                                </div>
                                                <p class="ft-gray">建议图片大小不超过1M</p>
                                            </div>
                                        </div>
                                        <div class="layui-form-item" pane>
                                            <label class="layui-form-label">扣费设置</label>
                                            <div class="layui-input-block block-blank">
                                                <div class="layui-clear m-b-10">
                                                    <div class="layui-input-inline not-pane-inline">
                                                        <p class="layui-form-mid">水量（升）</p>
                                                    </div>
                                                    <div class="layui-input-inline not-pane-inline">
                                                        <p class="layui-form-mid">时间（分）</p>
                                                    </div>
                                                    <div class="layui-input-inline not-pane-inline">
                                                        <p class="layui-form-mid">金额（元）</p>
                                                    </div>
                                                </div>
                                                {{# for(var i=0;i < 4;i++){ }}
                                                <div class="layui-clear m-b-10 cost_set_water">
                                                    <input type="text"
                                                           value="{{d.data != null && d.data.cost_set != null && d.data.cost_set[i].icon?d.data.cost_set[i].icon:''}}"
                                                           class="layui-input cost-icon hide">
                                                    <div class="layui-input-inline not-pane-inline">
                                                        <input type="text" value="{{i===0?'0.5':(i === 1?'1':(i===2?'2':'4'))}}"
                                                               placeholder="{{i===0?'0.5':(i === 1?'1':(i===2?'2':'4'))}}"
                                                               class="layui-input volume ft-gray"
                                                               readonly>
                                                    </div>
                                                    <div class="layui-input-inline not-pane-inline">
                                                        <input type="text"
                                                               value="{{d.data != null && d.data.cost_set != null && d.data.cost_set[i].duration?d.data.cost_set[i].duration:''}}"
                                                               lay-verify="required|number" placeholder="请输入时间"
                                                               autocomplete="off" class="layui-input duration">
                                                    </div>
                                                    <div class="layui-input-inline not-pane-inline">
                                                        <input type="text"
                                                               value="{{d.data != null && d.data.cost_set != null && d.data.cost_set[i].price?d.data.cost_set[i].price:''}}"
                                                               lay-verify="required|number" placeholder="请输入金额"
                                                               autocomplete="off" class="layui-input price">
                                                    </div>
                                                </div>
                                                {{# } }}
                                            </div>
                                        </div>

                                    </div>
                                    <div class="layui-form-item p-t-10">
                                        <button class="layui-btn" lay-submit lay-filter="base-save">保存</button>
                                        <button class="layui-btn layui-btn-primary" id="back">返回</button>
                                    </div>
                                </div>
                            </div>
                            <div class="layui-tab-item full-height">
                                <div class="layui-form layui-form-pane full-height flex flex-v">
                                    <div class="layui-clear flex-1">
                                        <div class="layui-form-item" pane="">
                                            <label class="layui-form-label">流量监测开关</label>
                                            <div class="layui-input-block">
                                                <input type="checkbox" name="flow_monitor_status"
                                                       lay-skin="switch" lay-text="开启|关闭"
                                                       {{d.data !=null && d.data.extend_set !=null &&
                                                       d.data.extend_set.flow_monitor_status=== 1?'checked':''}}>
                                            </div>
                                        </div>
                                        <div class="layui-form-item">
                                            <label class="layui-form-label">流量监测频率</label>
                                            <div class="layui-input-block">
                                                <input type="text" name="flow_monitor_rate"
                                                       value="{{d.data != null && d.data.extend_set != null?d.data.extend_set.flow_monitor_rate:''}}"
                                                       lay-verify="required|number"
                                                       placeholder="请输入流量监测频率（秒）" autocomplete="off"
                                                       class="layui-input">
                                            </div>
                                        </div>
                                        <div class="layui-form-item" pane>
                                            <label class="layui-form-label">消费模式</label>
                                            <div class="layui-input-block">
                                                <input type="radio" name="mode" value="1" title="计时"
                                                       {{d.data !=null && d.data.hard_set !=null &&
                                                       d.data.hard_set.mode== 1?'checked':''}} lay-filter="mode"/>
                                                <input type="radio" name="mode" value="0" title="计量"
                                                       {{d.data !=null && d.data.hard_set !=null &&
                                                       d.data.hard_set.mode== 0?'checked':''}} lay-filter="mode"/>
                                            </div>
                                        </div>
                                        <div class="layui-form-item" pane>
                                            <label class="layui-form-label">出水费率设置</label>
                                            <div class="layui-input-block block-blank">
                                                <div class="layui-clear m-b-10">
                                                    <label class="not-pane-label">扣款周期</label>
                                                    <div class="layui-input-inline not-pane-inline">
                                                        <input type="text" name="deduct_unit"
                                                               value="{{d.data != null && d.data.hard_set != null && d.data.hard_set.deduct_unit?d.data.hard_set.deduct_unit:''}}"
                                                               lay-verify="required|number" placeholder="请输入"
                                                               autocomplete="off" class="layui-input">
                                                    </div>
                                                    <label class="not-pane-label mode-unit">{{ d.data != null && d.data.hard_set
                                                        != null && d.data.hard_set.mode === 1?'秒':'脉冲'}}</label>
                                                </div>
                                                <hr>
                                                <div class="layui-clear m-b-10">
                                                    <div class="layui-input-inline not-pane-inline">
                                                        <p class="layui-form-mid">类型</p>
                                                    </div>
                                                    <div class="layui-input-inline not-pane-inline">
                                                        <p class="layui-form-mid">扣费金额（元）</p>
                                                    </div>
                                                </div>
                                                <div class="layui-clear m-b-10">
                                                    <div class="layui-input-inline not-pane-inline">
                                                        <input type="text" name="faucet_1_title"
                                                               value="{{d.data != null && d.data.hard_set != null && d.data.hard_set.faucet_1_title?d.data.hard_set.faucet_1_title:''}}"
                                                               lay-verify="required" placeholder="请输入出水类型"
                                                               autocomplete="off" class="layui-input">
                                                    </div>
                                                    <div class="layui-input-inline not-pane-inline">
                                                        <input type="text" name="faucet_1"
                                                               value="{{d.data != null && d.data.hard_set != null && d.data.hard_set.faucet_1?d.data.hard_set.faucet_1:''}}"
                                                               lay-verify="required|number" placeholder="请输入扣费金额"
                                                               autocomplete="off" class="layui-input">
                                                    </div>
                                                </div>
                                                <div class="layui-clear m-b-10">
                                                    <div class="layui-input-inline not-pane-inline">
                                                        <input type="text" name="faucet_2_title"
                                                               value="{{d.data != null && d.data.hard_set != null && d.data.hard_set.faucet_2_title?d.data.hard_set.faucet_2_title:''}}"
                                                               lay-verify="required" placeholder="请输入出水类型"
                                                               autocomplete="off" class="layui-input">
                                                    </div>
                                                    <div class="layui-input-inline not-pane-inline">
                                                        <input type="text" name="faucet_2"
                                                               value="{{d.data != null && d.data.hard_set != null && d.data.hard_set.faucet_2?d.data.hard_set.faucet_2:''}}"
                                                               lay-verify="required|number" placeholder="请输入扣费金额"
                                                               autocomplete="off" class="layui-input">
                                                    </div>
                                                </div>
                                                <div class="layui-clear m-b-10">
                                                    <div class="layui-input-inline not-pane-inline">
                                                        <input type="text" name="faucet_3_title"
                                                               value="{{d.data != null && d.data.hard_set != null && d.data.hard_set.faucet_3_title?d.data.hard_set.faucet_3_title:''}}"
                                                               lay-verify="required" placeholder="请输入出水类型"
                                                               autocomplete="off" class="layui-input">
                                                    </div>
                                                    <div class="layui-input-inline not-pane-inline">
                                                        <input type="text" name="faucet_3"
                                                               value="{{d.data != null && d.data.hard_set != null && d.data.hard_set.faucet_3?d.data.hard_set.faucet_3:''}}"
                                                               lay-verify="required|number" placeholder="请输入扣费金额"
                                                               autocomplete="off" class="layui-input">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="layui-form-item p-t-10">
                                        <button class="layui-btn" lay-submit lay-filter="device-save">保存</button>
                                        <button class="layui-btn layui-btn-primary" id="back">返回</button>
                                    </div>
                                </div>
                            </div>
                        </script>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    layui.use(['device/device', 'form'], function () {
        var $ = layui.$,
            form = layui.form,
            device = layui.admin.device;

        $(function () {
            form.on('radio(mode)', function(data){
                if(data.value == 1){
                    $('.mode-unit').html('秒')
                }else{
                    $('.mode-unit').html('脉冲')
                }
            });
            // 保存基础设置
            form.on('submit(base-save)', function () {
                var field = {}
                if (!$('.icon_url').val()) {
                    layer.alert('请上传图片！', {icon: 5});
                    return false;
                } else {
                    field.iconUrl = $('.icon_url').val();
                }
                var cost_set = [];
                $('.cost_set_water').each(function () {
                    cost_set.push({
                        icon: $(this).find('.cost-icon').val(),
                        price: $(this).find('.price').val(),
                        duration: $(this).find('.duration').val(),
                        volume: $(this).find('.volume').val()
                    })
                })
                field.costSet = cost_set;
                field.idList = layui.data('temporary').temporary;
                device.deviceSetting('/device-manage/drinks/cost-param', field);
            })

            // 保存设备设置
            form.on('submit(device-save)', function (obj) {
                var field = {}, extendSet = {}, hardSet = {};
                if (obj.field.flow_monitor_status === 'on') {
                    obj.field.flow_monitor_status = 1;
                } else {
                    obj.field.flow_monitor_status = 2;
                }
                extendSet.flow_monitor_status = obj.field.flow_monitor_status;
                extendSet.flow_monitor_rate = obj.field.flow_monitor_rate;

                hardSet.mode = obj.field.mode;
                hardSet.deduct_unit = obj.field.deduct_unit;
                hardSet.faucet_1_title = obj.field.faucet_1_title;
                hardSet.faucet_1 = obj.field.faucet_1;
                hardSet.faucet_2_title = obj.field.faucet_2_title;
                hardSet.faucet_2 = obj.field.faucet_2;
                hardSet.faucet_3_title = obj.field.faucet_3_title;
                hardSet.faucet_3= obj.field.faucet_3;

                field.extendSet = extendSet;
                field.hardSet = hardSet;
                field.idList = layui.data('temporary').temporary;

                device.deviceSetting('/device-manage/drinks/hard-param',field);
            })

            $(document).off('click', '#back')
            $(document).on('click', '#back', function () {
                window.history.go(-1);
            })
        })
    });

</script>